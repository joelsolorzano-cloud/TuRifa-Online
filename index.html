<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tablero de Rifa - ACCESO ADMINISTRADOR</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-image: url('fondo.jpg');  
            background-size: cover;  
            background-attachment: fixed;
            background-position: center;
            color: #333;
        }
        
        #logo-rifa {
            max-width: 400px;  
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: block;
            margin: -10px auto 25px auto;
        }

        #contenido-administrador {
            display: block;  
        }

        #contenedor-botones {
            margin-bottom: 25px;
            display: flex;  
            justify-content: center;
            gap: 15px;  
        }
        
        .boton-accion {
            border: none;
            padding: 15px 30px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #boton-acceso-admin {
            background-color: #6c757d;  
            color: white;
            padding: 10px 20px;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: block;  
            margin: 0 auto 15px auto;
        }
        #boton-acceso-admin:hover {
            background-color: #5a6268;
        }

        #boton-sorteo {
            background-color: #ffc107;  
            color: #333;
        }
        #boton-sorteo:hover:not(:disabled) {
            background-color: #e0a800;  
        }
        #boton-sorteo:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Estilos para el nuevo bot√≥n de Reiniciar Ganadores (Azul) */
        #boton-reiniciar-ganadores {  
            background-color: #007bff; /* Azul primario */
            color: white;
        }
        #boton-reiniciar-ganadores:hover:not(:disabled) {
            background-color: #0056b3;  
        }
        #boton-reiniciar-ganadores:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        #boton-reiniciar-boletos {  
            background-color: #dc3545;  
            color: white;
        }
        #boton-reiniciar-boletos:hover:not(:disabled) {
            background-color: #c82333;  
        }
        #boton-reiniciar-boletos:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        #resultado-sorteo {
            font-size: 1.3em;  
            font-weight: bold;
            color: #007bff;  
            margin-top: 20px;
            padding: 15px;
            border: 3px solid #007bff;
            border-radius: 8px;
            max-width: 650px;
            margin: 20px auto;
            background-color: rgba(255, 255, 255, 0.9);
            text-align: left;
        }
        
        #resultado-sorteo strong {
            display: block;
            margin: 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px dashed #ccc;
        }
        #resultado-sorteo strong:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        /* -------------------------------------- */
        /* --- ESTILOS PARA LOS RECUADROS FIJOS --- */
        /* -------------------------------------- */
        #contenedor-ganadores-fijos {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
            margin-bottom: 25px;
        }

        .display-ganador {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            width: 45%;
            text-align: left;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            line-height: 1.4;
        }
        
        #display-ganador-1 {
            border-left: 5px solid #ffc107; /* Color Primer Ganador */
        }
        #display-ganador-2 {
            border-left: 5px solid #007bff; /* Color Segundo Ganador */
        }
        /* -------------------------------------- */
        /* -------------------------------------- */


        #contador {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin: 25px auto 20px auto;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            display: inline-block;  
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #tablero {
            display: grid;
            grid-template-columns: repeat(10, 1fr);  
            gap: 10px;  
            max-width: 1400px;  
            margin: 20px auto;
            padding: 10px;
            background-color: skyblue; /* ¬°Color actualizado a azul cielo! */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;  
        }
        
        .boleto {
            padding: 0;  
            border: none;
            border-radius: 0;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;  
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;  
            
            background-image: url('boletos.png');  
            background-size: cover;  
            background-repeat: no-repeat;
            background-position: center;
            min-height: 63px; /* üõë AJUSTADO: 60px * 1.05 = 63px üõë */
            aspect-ratio: 2 / 1;  
            position: relative;
            overflow: hidden;  
        }
        
        .nombre-display {
            position: absolute;
            bottom: 5px;  
            left: 0;
            right: 0;
            font-size: 0.6em;  
            font-weight: bold;
            color: #333;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2px 5px;
            border-top: 1px solid #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
            margin: 0 auto;
        }

        .disponible .nombre-display {
            display: none;
        }
        .ocupado .nombre-display {
            display: block;
        }

        .numero-btn {
            font-weight: bold;
            font-size: 1.2em; /* üõë AJUSTE DE TAMA√ëO DE FUENTE üõë */
            cursor: pointer;
            position: absolute;  
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);  
            background-color: transparent;  
            color: white;  
            padding: 5px 10px;
            line-height: 1.2;
            width: fit-content;
            z-index: 2;  
        }
        .numero-btn:hover {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.9);  
        }
        
        .disponible {
            filter: grayscale(0%);  
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* CLASE MODIFICADA PARA COLOR ROJO */
        .ocupado {
            filter: brightness(85%) hue-rotate(340deg) saturate(150%);  
            box-shadow: 0 6px 12px rgba(255, 0, 0, 0.4);  
            border: 3px solid #dc3545;  
        }
        .ocupado .numero-btn {
            color: #fce38a;  
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
            cursor: default;  
        }

        .ruleta-flash {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 0 15px 5px #00ff00 !important;  
            filter: brightness(150%) hue-rotate(90deg) !important;  
            transition: all 0.05s ease-in-out !important;  
        }

        .ganador {
            transform: scale(1.1) rotate(-3deg);  
            box-shadow: 0 0 20px 8px #ffc107 !important;  
            filter: brightness(180%) saturate(150%) !important;  
            border: 5px solid #ffc107;  
        }

        /* --- ESTILOS DEL MODAL (Ventana Pop-up) --- */
        .modal {
            display: none;  
            position: fixed;  
            z-index: 100;  
            left: 0;
            top: 0;
            width: 100%;  
            height: 100%;  
            overflow: auto;  
            background-color: rgba(0,0,0,0.4);  
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;  
            padding: 25px;
            border: 1px solid #888;
            width: 80%;  
            max-width: 450px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            text-align: left;
        }

        .modal-content h3 {
            text-align: center;
            color: #007bff;
            margin-top: 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .modal-content input[type="text"] {
            width: 95%;
            padding: 10px;
            margin: 8px 0 15px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .modal-footer {
            text-align: right;
            margin-top: 20px;
        }

        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin-left: 10px;
        }

        #modal-btn-aceptar {
            background-color: #28a745;
            color: white;
        }
        #modal-btn-cancelar {
            background-color: #f44336;
            color: white;
        }
        /* --- FIN ESTILOS MODAL --- */
        
        #countdown-timer {
            margin-top: 40px;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.9);
            color: #28a745;  
            border: 2px solid #28a745;
            border-radius: 8px;
            max-width: 500px;
            margin: 40px auto 10px auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <img id="logo-rifa" src="Logotipo.jpg" alt="Logo de la Rifa"> 

    <div id="countdown-timer">
        Cargando fecha del pr√≥ximo sorteo...
    </div>

    <button id="boton-acceso-admin" onclick="solicitarAccesoAdmin()">Acceso Administrador</button>
    
    <div id="contenido-administrador">
        <div id="contenedor-botones">
            <button class="boton-accion" id="boton-sorteo" onclick="iniciarSorteoManual()" disabled>
                üèÜ ELEGIR 2 GANADORES AL AZAR üèÜ
            </button>
            <button class="boton-accion" id="boton-reiniciar-ganadores" onclick="reiniciarGanadores()" disabled>
                ‚ôªÔ∏è Reiniciar Ganadores
            </button>
            <button class="boton-accion" id="boton-reiniciar-boletos" onclick="reiniciarBoletos()" disabled>
                üóëÔ∏è Reiniciar Boletos
            </button>
        </div>

        <div id="contenedor-ganadores-fijos">
            <div class="display-ganador" id="display-ganador-1">
                1er Ganador: N/A
            </div>
            <div class="display-ganador" id="display-ganador-2">
                2do Ganador: N/A
            </div>
        </div>
        
        <div id="resultado-sorteo">
            Bienvenido al panel de administraci√≥n. Elige "Acceso Administrador" para habilitar las funciones.
        </div>
        
        <div id="contador">
            Boletos Seleccionados: 0 / 200
        </div>
        
        <div id="tablero">
        </div>
    </div>
    
    <div id="datosModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-titulo">Datos del Boleto</h3>
            
            <label for="modal-nombre">Nombre(s):</label>
            <input type="text" id="modal-nombre" placeholder="Nombre del participante" required>

            <label for="modal-apellido">Apellido(s):</label>
            <input type="text" id="modal-apellido" placeholder="Apellido del participante (opcional)">

            <label for="modal-telefono">Tel√©fono:</label>
            <input type="text" id="modal-telefono" placeholder="Tel√©fono de contacto (opcional)">

            <label for="modal-referencia">Referencia:</label>
            <input type="text" id="modal-referencia" placeholder="Qui√©n refiri√≥ la venta (opcional)">

            <div class="modal-footer">
                <button id="modal-btn-cancelar" onclick="ocultarModal()">Cancelar</button>
                <button id="modal-btn-aceptar" onclick="guardarDatosModal()">Guardar / Ocupar</button>
            </div>
        </div>
    </div>

    <audio id="sound-tic" src="tick.mp3" preload="auto"></audio>
    <audio id="sound-ganador" src="ganador.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // üö® CONFIGURACI√ìN DE LA CONTRASE√ëA üö®
        const CONTRASENA_ADMIN = "190323";  

        // üî• NUEVO: Configuraci√≥n de Firebase (Proporcionada por el usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyDZKDDSNcVQ1OUpjheDRJBeohvEwb1D8vU",
            authDomain: "turifa-online.firebaseapp.com",
            databaseURL: "https://turifa-online-default-rtdb.firebaseio.com",
            projectId: "turifa-online",
            storageBucket: "turifa-online.firebasestorage.app",
            messagingSenderId: "38618229946",
            appId: "1:38618229946:web:b3dd733ef4e3d0eb352683"
        };

        // üî• NUEVO: Inicializar Firebase y la referencia a la base de datos
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const refTickets = database.ref('rifa/tickets'); // Referencia al nodo principal

        const ticSound = document.getElementById('sound-tic');
        const ganadorSound = document.getElementById('sound-ganador');

        // **********************************************
        // üõë VARIABLES GLOBALES CORREGIDAS PARA TRABAJAR CON FIREBASE üõë
        // Estas variables se llenar√°n autom√°ticamente con los datos de Firebase.
        let datosParticipantes = {}; 
        let estadoBoletos = {}; 
        let administradorAutenticado = false;  
        let currentBoletoNumero = null;  
        
        let estadoSorteo = 0;  
        let primerGanadorNum = null;  
        let boletosOcupadosGlobal = [];
        
        // Declaraci√≥n global para los elementos del DOM y el total
        let contadorDisplay; 
        let botonSorteo;
        let totalBoletos = 200; // Asignaci√≥n de valor predeterminado
        // **********************************************


        function playTicSound() {
            if (ticSound) {
                ticSound.currentTime = 0;  
                ticSound.play().catch(e => {
                    console.warn("No se pudo reproducir el sonido 'tick'.", e);
                });
            }
        }
        
        function playGanadorSound() {
            if (ganadorSound) {
                ganadorSound.currentTime = 0;  
                ganadorSound.play().catch(e => {
                    console.warn("No se pudo reproducir el sonido 'ganador'.", e);
                });
            }
        }

        function getNombreGanador(numeroBoleto) {
            const datosGanador = datosParticipantes[numeroBoleto] || {nombre: 'el participante', apellido: ''};
            return `${datosGanador.nombre || ''} ${datosGanador.apellido || ''}`.trim() || 'el participante';
        }

        function anunciarGanador(numeroBoleto, puesto, esFinal) {
            if (!('speechSynthesis' in window)) {
                console.warn("La s√≠ntesis de voz no est√° soportada por este navegador.");
                return;
            }
            
            const synth = window.speechSynthesis;
            synth.cancel();  

            const nombreGanador = getNombreGanador(numeroBoleto);
            
            let textoAnuncio;
            if (esFinal) {
                 textoAnuncio = `¬°Sorteo finalizado! El segundo ganador es el boleto n√∫mero ${numeroBoleto}, correspondiente a ${nombreGanador}.`;
            } else {
                 textoAnuncio = `¬°Felicidades! El primer ganador es el boleto n√∫mero ${numeroBoleto}, correspondiente a ${nombreGanador}.`;
            }
            
            const utterance = new SpeechSynthesisUtterance(textoAnuncio);
            utterance.lang = 'es-ES';

            function setFemaleVoice() {
                const voices = synth.getVoices();
                let vozFemenina = null;
                let vozEspanolRespaldo = null;
                const femaleNames = ['monica', 'laura', 'samantha', 'sofia', 'eva', 'ana', 'female'];

                for (let i = 0; i < voices.length; i++) {
                    const voiceName = voices[i].name.toLowerCase();
                    if (voices[i].lang.startsWith('es')) {  
                        if (femaleNames.some(name => voiceName.includes(name))) {
                            vozFemenina = voices[i];
                            break;  
                        }
                        if (!vozEspanolRespaldo) {
                            vozEspanolRespaldo = voices[i];
                        }
                    }
                }

                if (vozFemenina) {
                    utterance.voice = vozFemenina;
                } else if (vozEspanolRespaldo) {
                    utterance.voice = vozEspanolRespaldo;
                }
                
                synth.speak(utterance);
            }

            if (synth.getVoices().length === 0) {
                synth.onvoiceschanged = setFemaleVoice;
            } else {
                setFemaleVoice();
            }
        }

        function iniciarContadorRegresivo() {
            const timerDisplay = document.getElementById('countdown-timer');
            if (!timerDisplay) return;  

            function actualizarContador() {
                const ahora = new Date();
                const diaSemanaActual = ahora.getDay();  
                let diasHastaDomingo = 0;
                
                if (diaSemanaActual !== 0) {
                    diasHastaDomingo = 7 - diaSemanaActual;
                }
                
                const fechaObjetivo = new Date(ahora);
                fechaObjetivo.setDate(ahora.getDate() + diasHastaDomingo);  
                fechaObjetivo.setHours(19, 0, 0, 0);  

                if (fechaObjetivo.getTime() < ahora.getTime()) {
                    fechaObjetivo.setDate(fechaObjetivo.getDate() + 7);
                }

                const diferencia = fechaObjetivo.getTime() - ahora.getTime();

                const segundos = Math.floor(diferencia / 1000);
                const minutos = Math.floor(segundos / 60);
                const horas = Math.floor(minutos / 60);
                const dias = Math.floor(horas / 24);

                const horasRestantes = horas % 24;
                const minutosRestantes = minutos % 60;
                const segundosRestantes = segundos % 60;

                if (diferencia <= 0) {
                    timerDisplay.textContent = "üéâ ¬°EL SORTEO EST√Å EN CURSO O HA FINALIZADO! üéâ";
                } else {
                    timerDisplay.innerHTML = `
                        Pr√≥ximo Sorteo: Domingo 7:00 PM<br>
                        Faltan:  
                        **${dias}** D√≠as,  
                        **${horasRestantes.toString().padStart(2, '0')}** Horas,  
                        **${minutosRestantes.toString().padStart(2, '0')}** Minutos,  
                        **${segundosRestantes.toString().padStart(2, '0')}** Segundos
                    `;
                }
            }

            actualizarContador();
            setInterval(actualizarContador, 1000);
        }
        
        function solicitarAccesoAdmin() {
            if (administradorAutenticado) {
                alert("Ya tienes acceso de administrador.");
                return;
            }

            const password = prompt("üö® INGRESA LA CONTRASE√ëA DE ADMINISTRADOR para activar las funciones de Sorteo y Reinicio:");

            if (password === CONTRASENA_ADMIN) {
                administradorAutenticado = true;
                alert("Acceso de administrador concedido. Funciones de Sorteo y Reinicio activadas.");
                
                document.getElementById('boton-sorteo').disabled = false;
                document.getElementById('boton-reiniciar-boletos').disabled = false;
                document.getElementById('boton-reiniciar-ganadores').disabled = false;  
                
                document.getElementById('boton-acceso-admin').style.display = 'none';
                
                // Reiniciar el bot√≥n al estado inicial al conceder acceso
                document.getElementById('boton-sorteo').textContent = "üèÜ ELEGIR 1er GANADOR üèÜ";
            } else {
                alert("Contrase√±a incorrecta. Las funciones de administraci√≥n permanecen bloqueadas.");
            }
            // Llama a actualizarContador para reflejar el estado correcto de los botones del admin
            actualizarContador(); 
        }
        
        // --- FUNCIONES DEL MODAL ---
        function mostrarModal(numero, esAdmin) {
            currentBoletoNumero = numero;
            const datos = datosParticipantes[numero] || {};
            const divBoleto = document.querySelector(`.boleto[data-numero="${numero}"]`);
            
            document.getElementById('modal-titulo').textContent = `Datos del Boleto #${numero}`;
            
            if (!esAdmin && divBoleto.classList.contains('ocupado')) {
                return;
            }

            document.getElementById('modal-nombre').value = datos.nombre || '';
            document.getElementById('modal-apellido').value = datos.apellido || '';
            document.getElementById('modal-telefono').value = datos.telefono || '';
            document.getElementById('modal-referencia').value = datos.referencia || '';

            document.getElementById('datosModal').style.display = 'block';
        }

        function ocultarModal() {
            document.getElementById('datosModal').style.display = 'none';
            currentBoletoNumero = null;
        }

        function guardarDatosModal() {
            if (!currentBoletoNumero) return;
            
            const nombre = document.getElementById('modal-nombre').value.trim();
            const apellido = document.getElementById('modal-apellido').value.trim();
            const telefono = document.getElementById('modal-telefono').value.trim();
            const referencia = document.getElementById('modal-referencia').value.trim();
            
            const divBoleto = document.querySelector(`.boleto[data-numero="${currentBoletoNumero}"]`);
            const nombreDisplay = divBoleto.querySelector('.nombre-display');
            
            if (nombre === '') {
                // Si el nombre est√° vac√≠o
                if (administradorAutenticado) {
                    // El admin puede LIBERAR el boleto (borrar datos)
                    liberarBoleto(currentBoletoNumero, divBoleto, nombreDisplay);
                    ocultarModal();  
                    return;
                } else {
                    // El p√∫blico debe ingresar un nombre
                    alert("Debes ingresar tu nombre para reservar el boleto.");
                    return;  
                }
            } else {
                // Hay nombre, se marca como ocupado
                marcarBoleto(currentBoletoNumero, divBoleto, nombreDisplay, nombre, apellido, telefono, referencia);
                ocultarModal();  
            }
        }

        // üî• MODIFICADA: Ahora usa Firebase para guardar los datos.
        function marcarBoleto(numero, divBoleto, nombreDisplay, nombre, apellido, telefono, referencia) {
            
            // üî• NUEVO: Crear el objeto para guardar en Firebase
            const ticketData = {
                status: 'ocupado', // Estado de Firebase
                nombre: nombre,
                apellido: apellido,
                telefono: telefono,
                referencia: referencia
            };

            // üî• NUEVO: Escribir en la base de datos
            refTickets.child(numero).set(ticketData)
                .then(() => {
                    console.log(`Boleto #${numero} marcado como ocupado en Firebase.`);
                })
                .catch((error) => {
                    alert("Error al guardar el boleto. Revisa tu conexi√≥n y reglas de Firebase.");
                    console.error(error);
                });
            
            // Actualizaci√≥n visual inmediata (el listener lo confirmar√°)
            divBoleto.classList.remove('disponible');
            divBoleto.classList.add('ocupado');
            
            // Se actualiza el nombre en pantalla inmediatamente
            const nombreCompletoDisplay = `${nombre} ${apellido}`.trim();
            nombreDisplay.textContent = nombreCompletoDisplay;
        }

        // üî• MODIFICADA: Ahora usa Firebase para liberar el boleto.
        function liberarBoleto(numero, divBoleto, nombreDisplay) {
            if (!administradorAutenticado) return;  

            if (divBoleto.classList.contains('ocupado')) {
                
                // üî• NUEVO: Marcarlo como 'disponible' en Firebase (eliminar√° el resto de datos)
                refTickets.child(numero).set({ status: 'disponible' })
                    .then(() => {
                        console.log(`Boleto #${numero} liberado en Firebase.`);
                    })
                    .catch((error) => {
                        alert("Error al liberar el boleto.");
                        console.error(error);
                    });

                // Actualizaci√≥n visual inmediata (el listener lo confirmar√°)
                divBoleto.classList.remove('ocupado');
                divBoleto.classList.add('disponible');
                nombreDisplay.textContent = '';
            }
        }

        // --- FIN FUNCIONES MODAL ---
        
        // üõë FUNCI√ìN DE ACTUALIZACI√ìN DEL CONTADOR (Ahora global y con control) üõë
        function actualizarContador() {
            // Aseg√∫rate de que las variables del DOM est√©n inicializadas antes de intentar usarlas
            if (!contadorDisplay || !botonSorteo || totalBoletos === undefined) {
                // Si no est√°n listas, intenta inicializarlas de nuevo si es necesario
                // Esto se hace en iniciarRifaAdministrador(), pero es un chequeo de seguridad.
                return;
            }

            let seleccionados = 0;
            for (let i = 1; i <= totalBoletos; i++) {
                const numero = i.toString();
                if (estadoBoletos[numero] === 'ocupado') {
                    seleccionados++;
                }
            }
            contadorDisplay.textContent = `Boletos Seleccionados: ${seleccionados} / ${totalBoletos}`;
            
            // L√≥gica para habilitar/deshabilitar el bot√≥n de sorteo
            if (administradorAutenticado) {
                if (estadoSorteo === 0) {
                    botonSorteo.disabled = seleccionados < 2;  
                } else if (estadoSorteo === 1) {
                     botonSorteo.disabled = (seleccionados - 1) < 1;  
                } else {
                     botonSorteo.disabled = true;
                }
            } else {
                botonSorteo.disabled = true;
            }
        }


        function iniciarRifaAdministrador() {
            // üõë Inicializaci√≥n de variables globales del DOM üõë
            contadorDisplay = document.getElementById('contador'); 
            botonSorteo = document.getElementById('boton-sorteo'); 
            const tablero = document.getElementById('tablero');
            const resultadoDisplay = document.getElementById('resultado-sorteo');
            
            // totalBoletos ya es 200 globalmente.

            let intervaloRuleta = null;
            const duracionAnimacionPorGanador = 8000;  
            const intervaloFlash = 80;

            // Se elimina la l√≥gica de carga de localStorage, ahora Firebase lo maneja.
            
            let ganadoresElegidos = [];
            
            // Inicializar texto del bot√≥n de sorteo
            if (administradorAutenticado) {
                 botonSorteo.textContent = (estadoSorteo === 0) ? "üèÜ ELEGIR 1er GANADOR üèÜ" : "üèÜ ELEGIR 2do GANADOR üèÜ";
                 document.getElementById('boton-acceso-admin').style.display = 'none';
                 document.getElementById('boton-reiniciar-boletos').disabled = false;
                 document.getElementById('boton-reiniciar-ganadores').disabled = false;  
            } else {
                 botonSorteo.textContent = "üèÜ ELEGIR 2 GANADORES AL AZAR üèÜ"; // Mensaje por defecto antes de login
                 botonSorteo.disabled = true;
                 document.getElementById('boton-reiniciar-ganadores').disabled = true;
                 document.getElementById('boton-reiniciar-boletos').disabled = true;
            }


            // üö® FUNCI√ìN DE REINICIO SUAVE DE BOLETOS üö® (Mantenida como funci√≥n global)
            // üî• MODIFICADA: Ahora usa Firebase para limpiar.
            window.reiniciarBoletos = function() { 
                if (!administradorAutenticado) {
                    solicitarAccesoAdmin();  
                    return;  
                }
                
                if (!confirm("¬øEst√°s seguro de que quieres REINICIAR SOLO LOS BOLETOS? Esto los marcar√° a todos como DISPONIBLES y BORRAR√Å los nombres de los participantes (los datos de los ganadores se conservar√°n en pantalla hasta un nuevo sorteo).")) {
                    return;  
                }
                
                // üî• NUEVO: Usar Firebase para borrar TODOS los datos de los tickets
                refTickets.set(null) // Esto borra todo lo que est√° bajo /rifa/tickets
                    .then(() => {
                        
                        // 2. Limpiar el DOM visualmente de cualquier clase que no quite el listener 
                        for (let i = 1; i <= totalBoletos; i++) {
                            const numero = i.toString();
                            const divBoleto = document.querySelector(`.boleto[data-numero="${numero}"]`);
                            if (divBoleto) {
                                divBoleto.classList.remove('ganador', 'ruleta-flash'); 
                            }
                        }

                        // 3. Resetear el estado del sorteo
                        reiniciarGanadoresSoft(); 
                        
                        // 4. Resetear el control y el texto de resultado
                        document.getElementById('boton-sorteo').textContent = "üèÜ ELEGIR 1er GANADOR üèÜ";
                        resultadoDisplay.textContent = "Boletos y resultados reiniciados. Presiona el bot√≥n para realizar un nuevo sorteo.";

                        alert("¬°Boletos reiniciados con √©xito!");

                    })
                    .catch((error) => {
                        alert("Error al intentar reiniciar los boletos en Firebase.");
                        console.error(error);
                    });
            }
            
            // üö® FUNCI√ìN DE REINICIO SUAVE DE GANADORES (L√≥gica interna) üö®
            function reiniciarGanadoresSoft() {
                // 1. Limpiar el estado interno del sorteo
                estadoSorteo = 0;
                primerGanadorNum = null;
                boletosOcupadosGlobal = [];  
                
                // 2. Limpiar el DOM de la interfaz de resultados
                
                // Quitar el estado 'ganador' de los boletos en el tablero
                document.querySelectorAll('.ganador').forEach(el => el.classList.remove('ganador'));
                
                // Limpiar los recuadros fijos
                document.getElementById('display-ganador-1').innerHTML = `1er Ganador: N/A`;
                document.getElementById('display-ganador-2').innerHTML = `2do Ganador: N/A`;

                // Resetear el bot√≥n de Sorteo y el texto de resultado
                document.getElementById('boton-sorteo').textContent = "üèÜ ELEGIR 1er GANADOR üèÜ";
                document.getElementById('boton-sorteo').disabled = false;
                document.getElementById('resultado-sorteo').textContent = "Resultados de Ganadores reiniciados. Presiona el bot√≥n para realizar un nuevo sorteo con los boletos existentes.";
                
                actualizarContador();
            }

            // üö® FUNCI√ìN PARA EL BOT√ìN AZUL (Llamando a la l√≥gica Soft) üö®
            window.reiniciarGanadores = function() {
                if (!administradorAutenticado) {
                    solicitarAccesoAdmin();  
                    return;  
                }

                if (!confirm("¬øEst√°s seguro de que quieres REINICIAR SOLO LOS GANADORES? Esto eliminar√° los resultados del sorteo actual y dejar√° los boletos OCUPADOS intactos para un nuevo sorteo.")) {
                    return;  
                }
                
                reiniciarGanadoresSoft();
                alert("¬°Resultados de Ganadores reiniciados con √©xito!");
            }


            // 3. Funci√≥n para animar y revelar un ganador 
            function animarGanador(boletosDisp, puesto, esSegundo) {
                return new Promise(resolve => {
                    let lastFlashedDiv = null;
                    const numeroGanador = boletosDisp[Math.floor(Math.random() * boletosDisp.length)];
                    
                    // Iniciar animaci√≥n
                    intervaloRuleta = setInterval(() => {
                        if (lastFlashedDiv) {
                            lastFlashedDiv.classList.remove('ruleta-flash');
                        }

                        const randomFlashedIndex = Math.floor(Math.random() * boletosDisp.length);
                        const numeroRandomFlashed = boletosDisp[randomFlashedIndex];
                        
                        const currentDiv = document.querySelector(`.boleto[data-numero="${numeroRandomFlashed}"]`);
                        if (currentDiv) {
                            currentDiv.classList.add('ruleta-flash');
                            lastFlashedDiv = currentDiv;
                            playTicSound();
                        }

                    }, intervaloFlash);
                    
                    // Detener animaci√≥n despu√©s de un tiempo
                    setTimeout(() => {
                        clearInterval(intervaloRuleta);

                        // Asegurar que el √∫ltimo flash se quite
                        if (lastFlashedDiv) {
                            lastFlashedDiv.classList.remove('ruleta-flash');
                        }
                        
                        // Resaltar al ganador final
                        const divGanador = document.querySelector(`.boleto[data-numero="${numeroGanador}"]`);
                        if (divGanador) {
                            divGanador.classList.add('ganador');
                            // Asegurarse de que no tenga la clase ocupado si es ganador
                            divGanador.classList.remove('ocupado'); 
                        }

                        playGanadorSound();
                        resolve(numeroGanador);
                    }, duracionAnimacionPorGanador);
                });
            }

            // 4. L√≥gica principal del sorteo
            window.iniciarSorteoManual = async function() {
                if (!administradorAutenticado) {
                    solicitarAccesoAdmin();  
                    return;
                }
                
                if (estadoSorteo === 2) {
                    alert("El sorteo de los dos ganadores ha finalizado. Usa 'Reiniciar Ganadores' si deseas volver a sortear.");
                    return;
                }

                if (estadoSorteo === 0) {
                    // Prepara la lista de boletos elegibles
                    boletosOcupadosGlobal = [];
                    for (let i = 1; i <= totalBoletos; i++) {
                        const numero = i.toString();
                        // Se usa estadoBoletos que fue llenado por el listener de Firebase
                        if (estadoBoletos[numero] === 'ocupado') { 
                            boletosOcupadosGlobal.push(numero);
                        }
                    }
                    
                    if (boletosOcupadosGlobal.length < 2) {
                        alert("Deben haber al menos 2 boletos ocupados para iniciar el sorteo.");
                        return;
                    }

                    botonSorteo.disabled = true;
                    resultadoDisplay.textContent = "üö® ¬°SORTEANDO EL 1er GANADOR! üö®";

                    // Sorteo del Primer Ganador
                    primerGanadorNum = await animarGanador(boletosOcupadosGlobal, 1, false);

                    // Actualiza la interfaz del Primer Ganador
                    const datosG1 = datosParticipantes[primerGanadorNum];
                    document.getElementById('display-ganador-1').innerHTML = `
                        **1er Ganador:** #${primerGanadorNum}<br>
                        **Nombre:** ${datosG1.nombre} ${datosG1.apellido}<br>
                        **Tel√©fono:** ${datosG1.telefono || 'N/A'}
                    `;
                    
                    resultadoDisplay.innerHTML = `
                        El 1er ganador es el boleto **#${primerGanadorNum}** (${getNombreGanador(primerGanadorNum)}).<br>
                        ¬°Felicidades! Presiona el bot√≥n para sortear el **2do Ganador**.
                    `;

                    anunciarGanador(primerGanadorNum, 1, false);

                    // Pasa al siguiente estado
                    estadoSorteo = 1;
                    botonSorteo.textContent = "ü•à ELEGIR 2do GANADOR ü•à";
                    botonSorteo.disabled = false;
                    
                } else if (estadoSorteo === 1) {
                    // Prepara la lista para el segundo sorteo (excluyendo al primer ganador)
                    const boletosSegundoSorteo = boletosOcupadosGlobal.filter(num => num !== primerGanadorNum);

                    if (boletosSegundoSorteo.length < 1) {
                        alert("No hay suficientes boletos restantes para sortear el 2do ganador.");
                        estadoSorteo = 2; // Marca como terminado si no hay m√°s opciones
                        botonSorteo.disabled = true;
                        return;
                    }

                    botonSorteo.disabled = true;
                    resultadoDisplay.textContent = "üö® ¬°SORTEANDO EL 2do GANADOR! üö®";
                    
                    // Sorteo del Segundo Ganador
                    const segundoGanadorNum = await animarGanador(boletosSegundoSorteo, 2, true);

                    // Actualiza la interfaz del Segundo Ganador
                    const datosG2 = datosParticipantes[segundoGanadorNum];
                    document.getElementById('display-ganador-2').innerHTML = `
                        **2do Ganador:** #${segundoGanadorNum}<br>
                        **Nombre:** ${datosG2.nombre} ${datosG2.apellido}<br>
                        **Tel√©fono:** ${datosG2.telefono || 'N/A'}
                    `;
                    
                    resultadoDisplay.innerHTML = `
                        ¬°SORTEO FINALIZADO! Los ganadores son:
                        <strong style="color: #ffc107;">1er Lugar: #${primerGanadorNum} (${getNombreGanador(primerGanadorNum)})</strong>
                        <strong style="color: #007bff;">2do Lugar: #${segundoGanadorNum} (${getNombreGanador(segundoGanadorNum)})</strong>
                    `;

                    anunciarGanador(segundoGanadorNum, 2, true);

                    // Finaliza el sorteo
                    estadoSorteo = 2;
                    botonSorteo.textContent = "‚úÖ SORTEO FINALIZADO ‚úÖ";
                    botonSorteo.disabled = true;
                }
            }


            // 5. Generaci√≥n de boletos y manejo de eventos
            for (let i = 1; i <= totalBoletos; i++) {
                const numero = i.toString();
                
                // üî• MODIFICADO: Solo creamos los divs, el listener de Firebase los pintar√°
                const divBoleto = document.createElement('div');
                divBoleto.className = `boleto disponible`; // Clase inicial de respaldo
                divBoleto.dataset.numero = numero;

                const numeroBtn = document.createElement('div');
                numeroBtn.className = 'numero-btn';
                numeroBtn.textContent = numero;
                
                const nombreDisplay = document.createElement('div');
                nombreDisplay.className = 'nombre-display';
                nombreDisplay.textContent = ''; // Limpiar el texto inicial
                
                divBoleto.appendChild(numeroBtn);
                divBoleto.appendChild(nombreDisplay);
                
                // Configurar el evento de click
                divBoleto.onclick = function() {
                    mostrarModal(numero, administradorAutenticado);
                };
                
                tablero.appendChild(divBoleto);
            }

            // üî• NUEVO: Configurar el Listener de Firebase (Carga de datos y actualizaci√≥n en tiempo real)
            refTickets.on('value', (snapshot) => {
                const tickets = snapshot.val() || {}; 
                
                // Reiniciamos los estados locales para el sorteo
                datosParticipantes = {};
                estadoBoletos = {};

                for (let i = 1; i <= totalBoletos; i++) {
                    const numero = i.toString();
                    
                    // Si no hay datos en Firebase, asumimos 'disponible'
                    const ticketData = tickets[numero] || { status: 'disponible' }; 
                    const divBoleto = document.querySelector(`.boleto[data-numero="${numero}"]`);
                    
                    // Si el elemento no existe, saltar (solo como chequeo de seguridad)
                    if (!divBoleto) continue; 
                    
                    const nombreDisplay = divBoleto.querySelector('.nombre-display');

                    // 1. Actualizar estados locales (datosParticipantes y estadoBoletos)
                    estadoBoletos[numero] = ticketData.status;
                    if (ticketData.status === 'ocupado') {
                        datosParticipantes[numero] = ticketData;
                    } else {
                        datosParticipantes[numero] = {};
                    }

                    // 2. Actualizar el DOM (el color y el nombre)
                    divBoleto.classList.remove('ocupado', 'disponible');
                    // Solo actualizamos el estado si el boleto NO ha sido marcado como ganador
                    if (!divBoleto.classList.contains('ganador')) {
                       divBoleto.classList.add(ticketData.status);
                    }
                    
                    if (ticketData.status === 'ocupado' && ticketData.nombre) {
                        nombreDisplay.textContent = `${ticketData.nombre} ${ticketData.apellido || ''}`.trim();
                    } else {
                        nombreDisplay.textContent = '';
                    }
                }
                
                // 3. Actualizar el contador despu√©s de cargar todos los estados
                actualizarContador(); 
            });


            // Re-exportar las funciones a la ventana para que los botones onclick funcionen
            window.solicitarAccesoAdmin = solicitarAccesoAdmin;
            window.iniciarSorteoManual = iniciarSorteoManual; 
            
            // Inicializar contadores y temporizador
            iniciarContadorRegresivo();
        }

        // Inicia todo al cargar el DOM
        document.addEventListener('DOMContentLoaded', iniciarRifaAdministrador);
    </script>
</body>
</html>

